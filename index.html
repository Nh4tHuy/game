<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Master Pro v5.3 - Professional Gameplay Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            options: { enableMenu: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        :root {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --accent: #3b82f6;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-main); color: var(--text-main); overflow-x: hidden; }
        .tab-active { border-bottom: 4px solid var(--accent); color: var(--accent); font-weight: 900; }
        .glass-card { background: var(--bg-card); border: 1px solid #334155; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
        .topic-card { background: #1e293b; color: #f8fafc; border: 1px solid #334155; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .topic-card:hover { transform: translateY(-8px); border-color: var(--accent); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4); }
        .hidden-content { display: none !important; }
        
        /* Matching Game */
        .drag-item { cursor: grab; background: #0f172a; border: 2px solid #334155; user-select: none; touch-action: none; position: relative; }
        .drag-item:active { cursor: grabbing; }
        .drag-item.matched { display: none !important; }
        .drop-zone { border: 2px dashed #334155; border-radius: 1.5rem; min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #0f172a; transition: all 0.3s; padding: 1rem; }
        .drop-zone.drag-over { border-color: var(--accent); background: #1e293b; transform: scale(1.02); }
        .drop-zone.correct-match { border-style: solid; border-color: #10b981; background: #064e3b; }
        .drop-zone.wrong-match { animation: shake 0.5s; border-color: #ef4444; background: #451a1a; }

        /* Crossword */
        .char-box { width: 38px; height: 45px; background: #0f172a; border: 2px solid #334155; border-radius: 8px; text-align: center; font-weight: 900; color: white; text-transform: uppercase; outline: none; transition: all 0.2s; }
        .char-box:focus { border-color: var(--accent); transform: scale(1.05); }
        .char-correct { background: #059669 !important; border-color: #10b981 !important; color: white !important; }
        .char-wrong { background: #7f1d1d !important; border-color: #ef4444 !important; }

        /* Fill in Blanks */
        .blank-input-large { width: 100%; background: #0f172a; border: 3px solid #334155; border-radius: 20px; font-size: 24px; font-weight: 900; padding: 20px; color: #fff; text-align: center; outline: none; transition: all 0.3s; }
        .blank-input-large:focus { border-color: var(--accent); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }

        /* Generic Quiz Buttons */
        .answer-btn { transition: all 0.2s; cursor: pointer; border: 2px solid #334155; background: #1e293b; color: #cbd5e1; display: flex; align-items: center; }
        .answer-btn:hover:not(.pointer-events-none) { border-color: var(--accent); background: #334155; }
        .correct { background: #059669 !important; border-color: #10b981 !important; color: white !important; }
        .incorrect { background: #dc2626 !important; border-color: #ef4444 !important; color: white !important; }
        .answer-label-box { background: #0f172a; color: var(--accent); flex-shrink: 0; transition: all 0.2s; }
        .correct .answer-label-box { background: #064e3b; color: white; }
        .incorrect .answer-label-box { background: #7f1d1d; color: white; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        
        .license-overlay { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(6px); z-index: 50; }
        .status-badge { font-size: 9px; padding: 2px 8px; border-radius: 6px; font-weight: 900; text-transform: uppercase; }
        .status-active { background: #10b981; color: white; }
        .status-locked { background: #ef4444; color: white; }

        textarea, input, select { background: #0f172a !important; color: white !important; border: 1px solid #334155 !important; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        mjx-container { display: inline-block !important; margin: 0 2px !important; vertical-align: middle !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col" oncontextmenu="return false;">

    <!-- NAVIGATION -->
    <nav class="bg-slate-900 shadow-xl border-b border-slate-800 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center h-16">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-xl text-white shadow-lg shadow-blue-500/20"><i class="fas fa-graduation-cap"></i></div>
                <span class="font-black text-xl tracking-tighter uppercase text-white">Math<span class="text-blue-500">Master</span> <span class="text-[10px] bg-blue-500 px-1 rounded ml-1">v5.3</span></span>
            </div>
            <div class="flex space-x-6 h-full font-bold text-sm">
                <button onclick="switchTab('home')" class="nav-item h-full px-2 tab-active" id="btn-home">Trang chủ</button>
                <button onclick="switchTab('stats')" class="nav-item h-full px-2 text-slate-400" id="btn-stats">Thống kê</button>
                <button onclick="switchTab('setup')" class="nav-item h-full px-2 text-slate-400" id="btn-setup">Thiết lập</button>
                <button onclick="switchTab('settings')" class="nav-item h-full px-2 text-slate-400" id="btn-settings">Cài đặt</button>
            </div>
        </div>
    </nav>

    <main id="dashboard-view" class="flex-grow container mx-auto px-4 py-8 max-w-6xl">
        
        <!-- HOME TAB -->
        <section id="tab-home" class="tab-content">
            <div class="max-w-5xl mx-auto space-y-8">
                <div class="glass-card p-8 rounded-[32px] border-2 border-slate-800">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">1. Chọn Lớp học</label>
                            <select id="sel-class" class="w-full p-4 rounded-xl font-bold outline-none"></select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">2. Lọc cơ chế game</label>
                            <div class="flex gap-2">
                                <select id="filter-game-type" onchange="renderHome()" class="flex-grow p-4 rounded-xl font-bold outline-none">
                                    <option value="all">Tất cả chế độ</option>
                                    <option value="quiz">Trắc nghiệm ABCD</option>
                                    <option value="dungsai">Đúng / Sai</option>
                                    <option value="noitu">Kéo thả nối cặp</option>
                                    <option value="ochu">Giải ô chữ</option>
                                    <option value="dienkhuyet">Điền khuyết</option>
                                </select>
                                <button onclick="toggleSound()" id="btn-sound-toggle" title="Bật/Tắt âm thanh" class="p-4 bg-slate-800 rounded-xl text-blue-400 hover:bg-slate-700 transition-colors w-14 flex items-center justify-center">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                            </div>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-xl text-center">
                            <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest animate-pulse">Chọn bộ đề bên dưới <i class="fas fa-arrow-down ml-2"></i></span>
                        </div>
                    </div>
                </div>
                <div id="home-topics-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </section>

        <!-- STATS TAB -->
        <section id="tab-stats" class="tab-content hidden-content space-y-10">
            <div id="stats-lock" class="text-center py-20 glass-card rounded-[40px]">
                <i class="fas fa-lock text-5xl text-slate-700 mb-4"></i>
                <h2 class="text-xl font-black text-white uppercase">Dữ liệu bị khóa</h2>
                <p class="text-slate-400 text-sm mt-2">Kích hoạt tài khoản để mở khóa thống kê.</p>
            </div>
            <div id="stats-unlocked" class="hidden-content space-y-12">
                <div id="stats-summary" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
                <div>
                    <h3 class="font-black text-white mb-6 uppercase text-sm tracking-widest flex items-center gap-2"><i class="fas fa-crown text-yellow-500"></i> Bảng vinh danh Top 5</h3>
                    <div id="leaderboards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
                <div class="glass-card p-8 rounded-3xl overflow-hidden">
                    <h3 class="font-black text-white mb-6 uppercase text-sm tracking-widest flex items-center gap-2"><i class="fas fa-table text-purple-500"></i> Hiệu suất đúng theo chủ đề</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-900 text-slate-500 font-black uppercase text-[10px]">
                                <tr>
                                    <th class="p-4">Chủ đề</th>
                                    <th class="p-4">Loại Game</th>
                                    <th class="p-4">Lượt chơi</th>
                                    <th class="p-4">Chính xác TB</th>
                                </tr>
                            </thead>
                            <tbody id="stats-performance-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- SETUP TAB -->
        <section id="tab-setup" class="tab-content hidden-content space-y-10">
            <div id="setup-lock" class="text-center py-20 glass-card rounded-[40px]">
                <i class="fas fa-user-shield text-5xl text-slate-700 mb-4"></i>
                <h2 class="text-xl font-black text-white uppercase">Khu vực quản trị</h2>
                <p class="text-slate-400 text-sm mt-2">Đăng nhập kích hoạt để sử dụng.</p>
            </div>
            <div id="setup-unlocked" class="hidden-content space-y-12">
                <!-- Lớp học -->
                <div class="glass-card p-8 rounded-[32px] border-l-8 border-blue-500 grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h3 class="font-black text-white uppercase tracking-tight flex justify-between items-center">
                            Quản lý Lớp học
                            <span id="class-edit-badge" class="hidden-content text-[10px] bg-blue-600 px-2 py-1 rounded">ĐANG SỬA</span>
                        </h3>
                        <input type="text" id="setup-class-name" placeholder="Tên lớp..." class="w-full p-4 rounded-xl font-bold">
                        <textarea id="setup-class-students" placeholder="Mỗi dòng một tên học sinh..." class="w-full p-4 rounded-xl font-bold h-32"></textarea>
                        <div class="flex gap-2">
                            <button onclick="saveClassAction()" id="btn-save-class" class="flex-grow py-4 bg-blue-600 text-white font-black rounded-xl shadow-lg uppercase text-xs">LƯU LỚP HỌC</button>
                            <button onclick="cancelClassEdit()" id="btn-cancel-class" class="hidden-content px-6 bg-slate-700 text-white font-black rounded-xl uppercase text-[10px]">HỦY</button>
                        </div>
                    </div>
                    <div id="list-classes" class="bg-slate-900/50 p-4 rounded-2xl max-h-[300px] overflow-y-auto space-y-2 border border-slate-800"></div>
                </div>

                <!-- Bộ đề -->
                <div class="glass-card p-8 rounded-[32px] border-l-8 border-purple-500 grid grid-cols-1 lg:grid-cols-2 gap-8 relative">
                    <div class="space-y-4 flex flex-col h-full">
                        <h3 class="font-black text-white uppercase tracking-tight flex justify-between items-center">
                            Thiết lập Bộ đề câu hỏi
                            <span id="set-edit-badge" class="hidden-content text-[10px] bg-purple-600 px-2 py-1 rounded">ĐANG SỬA</span>
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="setup-set-title" placeholder="Tên chủ đề..." class="p-4 rounded-xl font-bold">
                            <select id="setup-set-type" onchange="renderQuestionFormBlocks()" class="p-4 rounded-xl font-bold">
                                <option value="quiz">Trắc nghiệm ABCD</option>
                                <option value="dungsai">Đúng / Sai</option>
                                <option value="noitu">Nối cặp (Matching)</option>
                                <option value="ochu">Giải ô chữ (Crossword)</option>
                                <option value="dienkhuyet">Điền khuyết (Fill)</option>
                            </select>
                        </div>
                        
                        <div class="relative flex-grow flex flex-col min-h-[350px]">
                            <!-- Guard Layer -->
                            <div id="license-guard" class="hidden-content absolute inset-0 license-overlay flex flex-col items-center justify-center text-center p-6 rounded-2xl">
                                <i class="fas fa-lock text-red-500 text-4xl mb-4"></i>
                                <p class="text-white font-black uppercase text-xs tracking-widest mb-2">Chưa kích hoạt bản quyền</p>
                                <p class="text-slate-400 text-[10px] leading-relaxed">Vui lòng nhập mã Key của loại trò chơi này<br>tại tab Cài đặt để mở khóa.</p>
                            </div>
                            
                            <div id="setup-questions-editor" class="space-y-4 max-h-[450px] overflow-y-auto pr-2 mt-4"></div>
                        </div>

                        <button id="btn-add-q" onclick="addNewQuestionToForm()" class="w-full py-3 border-2 border-dashed border-slate-700 text-slate-500 rounded-xl font-bold uppercase text-[10px] hover:border-slate-500 transition-colors">+ THÊM DÒNG CÂU HỎI</button>
                        <div class="flex gap-2 mt-2">
                            <button id="btn-save-set" onclick="saveSetAction()" class="flex-grow py-4 bg-purple-600 text-white font-black rounded-xl shadow-lg uppercase text-xs">LƯU BỘ CÂU HỎI</button>
                            <button onclick="cancelSetEdit()" id="btn-cancel-set" class="hidden-content px-6 bg-slate-700 text-white font-black rounded-xl uppercase text-[10px]">HỦY</button>
                        </div>
                    </div>
                    <div id="list-sets" class="bg-slate-900/50 p-4 rounded-2xl max-h-[650px] overflow-y-auto space-y-4 border border-slate-800"></div>
                </div>
            </div>
        </section>

        <!-- SETTINGS TAB -->
        <section id="tab-settings" class="tab-content hidden-content space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- License Form -->
                <div class="glass-card p-8 rounded-3xl flex flex-col">
                    <h3 class="font-black text-white mb-6 uppercase text-xs tracking-widest flex justify-between items-center border-b border-slate-700 pb-4">
                        Kích hoạt Bản quyền
                        <span id="display-user" class="text-blue-500 font-black italic">CHƯA ĐĂNG NHẬP</span>
                    </h3>
                    
                    <div class="space-y-6 flex-grow">
                        <div class="space-y-4">
                            <div class="bg-slate-900/80 p-3 rounded-xl border border-blue-500/30 mb-2">
                                <p class="text-[10px] font-bold text-blue-400"><i class="fas fa-info-circle mr-2"></i> Lưu ý: Key có thời hạn sử dụng là 7 ngày.</p>
                            </div>
                            <div>
                                <label class="text-[9px] font-black text-slate-500 uppercase mb-2 block">Tên người dùng (User)</label>
                                <input type="text" id="inp-user" placeholder="Nhập User..." class="w-full p-4 rounded-xl outline-none font-bold text-sm">
                            </div>
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="text-[9px] font-black text-slate-500 uppercase mb-2 block">Chọn trò chơi muốn mở khóa</label>
                                    <select id="inp-game-type" class="w-full p-4 rounded-xl font-bold text-xs bg-slate-900 border-slate-800">
                                        <option value="quiz">Trắc nghiệm ABCD</option>
                                        <option value="dungsai">Đúng / Sai</option>
                                        <option value="noitu">Nối cặp (Matching)</option>
                                        <option value="ochu">Giải ô chữ (Crossword)</option>
                                        <option value="dienkhuyet">Điền khuyết (Fill)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[9px] font-black text-slate-500 uppercase mb-2 block">Mã Key bản quyền</label>
                                    <input type="password" id="inp-key" placeholder="Nhập Key..." class="w-full p-4 rounded-xl outline-none font-bold text-sm">
                                </div>
                            </div>
                            <button onclick="handleAuth()" class="w-full py-4 bg-blue-600 text-white font-black rounded-xl shadow-lg hover:bg-blue-500 transition-all uppercase text-xs tracking-widest">XÁC THỰC KEY</button>
                        </div>

                        <div class="pt-6 border-t border-slate-700">
                            <h4 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Trạng thái các cơ chế</h4>
                            <div class="space-y-2" id="license-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Admin Management -->
                <div class="glass-card p-8 rounded-3xl h-full flex flex-col">
                    <h3 class="font-black text-red-400 mb-6 uppercase text-xs tracking-widest border-b border-red-900/30 pb-4">Quản lý hệ thống</h3>
                    <div class="space-y-4 flex-grow">
                        <button onclick="timedReset('stats')" class="w-full py-4 bg-red-900/20 text-red-400 font-bold rounded-xl border border-red-800 text-xs uppercase tracking-widest hover:bg-red-900/40">Làm sạch lịch sử thi</button>
                        <button onclick="timedReset('all')" class="w-full py-4 bg-red-600 text-white font-bold rounded-xl text-xs shadow-lg uppercase tracking-widest hover:bg-red-500">Khôi phục cài đặt gốc</button>
                        <div class="glass-card p-8 rounded-3xl border-l-4 border-l-blue-500">
                            <h3 class="font-black text-white mb-6 uppercase text-xs tracking-widest flex items-center gap-2"><i class="fas fa-book-open text-blue-500"></i> Hướng dẫn</h3>
                             <div class="space-y-4 text-sm text-slate-300">
                        <div class="flex gap-4">
                            <span class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-[10px] font-black shrink-0">1</span>
                            <p>Vào tab <b>Cài đặt</b> và nhập Key bản quyền để mở khóa các tính năng quản trị.</p>
                        </div>
                        <div class="flex gap-4">
                            <span class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-[10px] font-black shrink-0">2</span>
                            <p>Sử dụng tab <b>Thiết lập</b> để tạo danh sách Lớp học và các bộ đề câu hỏi toán học (hỗ trợ LaTeX).</p>
                        </div>
                        <div class="flex gap-4">
                            <span class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-[10px] font-black shrink-0">3</span>
                            <p>Quay lại <b>Trang chủ</b>, chọn lớp và chủ đề. Hệ thống sẽ quay số ngẫu nhiên học sinh để bắt đầu thi.</p>
                        </div>
                        <div class="flex gap-4">
                            <span class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-[10px] font-black shrink-0">4</span>
                            <p>Xem kết quả chi tiết và xếp hạng tại tab <b>Thống kê</b> sau khi hoàn thành lượt chơi.</p>
                        </div>
                    </div>
                </div>
                        <div class="glass-card p-8 rounded-3xl border-l-4 border-l-purple-500">
                              <h3 class="font-black text-white mb-6 uppercase text-xs tracking-widest flex items-center gap-2"><i class="fas fa-info-circle text-purple-500"></i> Thông tin Web App</h3>
                             <div class="space-y-3">
                                <div class="flex justify-between text-[11px] font-bold">
                                    <span class="text-slate-500 uppercase">Lưu trữ</span>
                                    <span class="text-emerald-500">Local Persistence</span>
                                </div>
                                <div class="flex justify-between text-[11px] font-bold">
                                    <span class="text-slate-500 uppercase">Vesion</span>
                                    <span class="text-blue-400 italic">5.3.1 - Auto Expire</span>
                                </div>
                                <div class="flex justify-between text-[11px] font-bold">
                                    <span class="text-slate-500 uppercase">Phiên bản</span>
                                    <span id="foot-status" class="text-slate-300">Non-Active</span>
                                </div>
                                <div class="flex justify-between text-[11px] font-bold">
                                    <span class="text-slate-500 uppercase">Tác giả</span>
                                    <span class="text-400 italic">Nhật Huy</span>
                                </div>
                                <div class="flex justify-between text-[11px] font-bold">
                                    <span class="text-slate-500 uppercase">User hiện tại</span>
                                    <span id="stat-user" class="text-slate-300">N/A</span>
                                </div>
                             </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- PICKER VIEW -->
    <section id="picker-view" class="hidden-content fixed inset-0 bg-slate-950 z-[100] flex flex-col items-center justify-center text-white">
        <h2 class="text-xl font-bold mb-12 uppercase tracking-[0.3em] text-slate-500">Đang chọn học sinh ngẫu nhiên...</h2>
        <div id="spinning-name" class="text-6xl md:text-8xl font-black py-10 px-12 bg-slate-900 rounded-[40px] w-full max-w-4xl text-center border-4 border-dashed border-slate-700 text-blue-400">...</div>
    </section>

    <!-- GAME VIEW -->
    <section id="game-view" class="hidden-content fixed inset-0 bg-slate-950 z-[90] flex flex-col p-4 overflow-y-auto">
        <div class="max-w-7xl mx-auto w-full flex-grow flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <div class="flex gap-4">
                    <div class="bg-slate-900 px-6 py-3 rounded-xl border border-slate-800 flex items-center gap-3">
                        <i class="fas fa-user-graduate text-blue-400"></i>
                        <span id="game-student-name" class="font-black text-white uppercase text-sm">Học sinh</span>
                    </div>
                    <div class="bg-slate-900 px-6 py-3 rounded-xl border border-slate-800 flex items-center gap-3">
                        <span class="font-black text-blue-400 text-sm uppercase">CÂU ĐÚNG: <span id="game-score">0</span></span>
                    </div>
                </div>
                <button onclick="confirmExitGame()" class="bg-red-900/30 text-red-400 px-6 py-3 rounded-xl font-black text-xs uppercase border border-red-800">Thoát</button>
            </div>
            <div id="game-container" class="glass-card p-8 rounded-[40px] flex-grow flex flex-col relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-slate-800">
                    <div id="game-bar" class="h-full bg-blue-500 transition-all duration-700 w-0"></div>
                </div>
                <div id="game-content" class="h-full flex flex-col overflow-y-auto"></div>
            </div>
        </div>
    </section>

    <!-- RESULT VIEW -->
    <section id="result-view" class="hidden-content fixed inset-0 bg-slate-950 z-[110] flex items-center justify-center p-6 text-center text-white">
        <div class="max-w-2xl w-full glass-card p-12 rounded-[56px] border-2 border-blue-900">
            <i class="fas fa-trophy text-7xl text-yellow-500 mb-6 animate-bounce"></i>
            <h2 class="text-4xl font-black mb-2 uppercase italic">Hoàn thành bài thi</h2>
            <p id="res-student" class="py-2 px-10 bg-blue-600 text-white rounded-full font-black inline-block mb-10 uppercase text-xs"></p>
            <div class="grid grid-cols-2 gap-6 mb-10 text-white">
                <div class="bg-slate-950 p-8 rounded-3xl border border-slate-800">
                    <p class="text-[10px] font-black text-slate-500 uppercase mb-2">Số câu đúng</p>
                    <p id="res-score" class="text-5xl font-black">0/0</p>
                </div>
                <div class="bg-slate-950 p-8 rounded-3xl border border-slate-800">
                    <p class="text-[10px] font-black text-slate-500 uppercase mb-2">Chính xác</p>
                    <p id="res-acc" class="text-5xl font-black text-blue-500">0%</p>
                </div>
            </div>
            <button onclick="location.reload()" class="w-full py-5 bg-white text-slate-900 font-black rounded-2xl shadow-xl uppercase tracking-widest hover:scale-105 transition">Về Trang Chủ</button>
        </div>
    </section>

    <footer class="bg-slate-900 border-t border-slate-800 py-8 mt-auto">
        <div class="container mx-auto px-4 max-w-6xl flex justify-between items-center text-[10px] text-slate-500 font-bold uppercase tracking-widest">
            <p>Math Master Pro <span class="text-blue-500">v5.3 Ultimate</span></p>
            <p id="foot-status" class="text-red-500 italic">Chưa đăng nhập</p>
        </div>
    </footer>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzz3sX1jrj4xUzqBE-oT29Aa3ScUDwEpyFSNS3LVWFs9fVvxtr479ZAMD2aKDZc7h5Qtw/exec";
        
        // --- SOUNDS SYSTEM ---
        const audioCorrect = new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3');
        const audioWrong = new Audio('https://assets.mixkit.co/active_storage/sfx/3090/3090-preview.mp3');
        const audioWin = new Audio('https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3');

        function playSfx(type) {
            if (typeof store !== 'undefined' && store.soundEnabled === false) return;
            try {
                if(type === 'correct') {
                    audioCorrect.currentTime = 0;
                    audioCorrect.play();
                } else if(type === 'wrong') {
                    audioWrong.currentTime = 0;
                    audioWrong.play();
                } else if(type === 'win') {
                    audioWin.currentTime = 0;
                    audioWin.play();
                }
            } catch(e) { console.warn("Audio play failed", e); }
        }

        let store = JSON.parse(localStorage.getItem('math_master_v5_db')) || {
            active: false,
            user: '',
            keys: {}, 
            activatedGames: { quiz: false, dungsai: false, noitu: false, ochu: false, dienkhuyet: false },
            classes: [],
            sets: [],
            history: [],
            soundEnabled: true 
        };

        if (store.soundEnabled === undefined) store.soundEnabled = true;

        const GAME_TYPES = {
            quiz: { name: 'Trắc nghiệm ABCD', icon: 'fa-shapes', color: 'blue' },
            dungsai: { name: 'Đúng / Sai', icon: 'fa-check-square', color: 'emerald' },
            noitu: { name: 'Kéo thả nối cặp', icon: 'fa-link', color: 'orange' },
            ochu: { name: 'Giải ô chữ', icon: 'fa-th-list', color: 'purple' },
            dienkhuyet: { name: 'Điền khuyết', icon: 'fa-keyboard', color: 'pink' }
        };

        let tempQuestions = [];
        let play = { type: '', q: [], cur: 0, score: 0, student: '', mistakes: [], noituMatched: 0, ochuRevealed: [], ochuSolved: [] };
        let editingClassIdx = null;
        let editingSetIdx = null;

        function sync() { localStorage.setItem('math_master_v5_db', JSON.stringify(store)); }

        function toggleSound() {
            store.soundEnabled = !store.soundEnabled;
            sync();
            updateSoundUI();
        }

        function updateSoundUI() {
            const btn = document.getElementById('btn-sound-toggle');
            if (!btn) return;
            if (store.soundEnabled) {
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                btn.className = "p-4 bg-slate-800 rounded-xl text-blue-400 hover:bg-slate-700 transition-colors w-14 flex items-center justify-center";
            } else {
                btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                btn.className = "p-4 bg-slate-800 rounded-xl text-slate-500 hover:bg-slate-700 transition-colors w-14 flex items-center justify-center";
            }
        }

        async function handleAuth() {
            const u = document.getElementById('inp-user').value.trim();
            const g = document.getElementById('inp-game-type').value;
            const k = document.getElementById('inp-key').value.trim();
            if(!u || !k) return Swal.fire('Lỗi', 'Vui lòng nhập đầy đủ User và Key.', 'warning');
            Swal.fire({ title: 'Đang xác thực...', didOpen: () => Swal.showLoading() });
            try {
                const r = await fetch(`${GAS_URL}?id=${u}&game=${g}&key=${k}`);
                const res = await r.text();
                if (res === "valid") {
                    store.active = true; 
                    store.user = u; 
                    store.activatedGames[g] = true;
                    if(!store.keys) store.keys = {};
                    store.keys[g] = k; 
                    sync(); updateAuthUI();
                    Swal.fire('Thành công', `Đã mở khóa: ${GAME_TYPES[g].name}`, 'success');
                } else if (res === "expired") {
                    Swal.fire('Hết hạn', 'Key của bạn đã hết hạn sử dụng (7 ngày).', 'warning');
                } else {
                    Swal.fire('Thất bại', 'User hoặc Key không chính xác.', 'error');
                }
            } catch (e) { Swal.fire('Lỗi mạng', 'Không thể kết nối máy chủ.', 'error'); }
        }

        function updateAuthUI() {
            const anyActive = Object.values(store.activatedGames).some(v => v);
            if (anyActive) {
                ['setup-lock', 'stats-lock'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.add('hidden-content');
                });
                ['setup-unlocked', 'stats-unlocked'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.remove('hidden-content');
                });
                document.getElementById('display-user').innerText = store.user.toUpperCase();
                document.getElementById('stat-user').innerText = store.user;
                document.getElementById('foot-status').innerText = "Premium Active";
                document.getElementById('foot-status').className = "text-emerald-500 font-black";
            } else {
                ['setup-lock', 'stats-lock'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.remove('hidden-content');
                });
                ['setup-unlocked', 'stats-unlocked'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.add('hidden-content');
                });
                document.getElementById('foot-status').innerText = "Chưa kích hoạt";
                document.getElementById('foot-status').className = "text-red-500 italic";
            }
            const list = document.getElementById('license-list');
            list.innerHTML = Object.keys(GAME_TYPES).map(type => {
                const active = store.activatedGames[type];
                return `
                    <div class="flex justify-between items-center p-3 bg-slate-800/50 rounded-xl border border-slate-700/50">
                        <div class="flex items-center gap-3">
                            <i class="fas ${GAME_TYPES[type].icon} text-${GAME_TYPES[type].color}-500 text-xs"></i>
                            <span class="text-[10px] font-bold text-slate-300 uppercase">${GAME_TYPES[type].name}</span>
                        </div>
                        <span class="status-badge ${active ? 'status-active' : 'status-locked'}">
                            ${active ? 'Đã mở' : 'Bị khóa'}
                        </span>
                    </div>
                `;
            }).join('');
        }

        function switchTab(t) {
            cancelClassEdit(); cancelSetEdit();
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden-content'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('tab-active', 'text-blue-500'));
            document.getElementById(`tab-${t}`).classList.remove('hidden-content');
            document.getElementById(`btn-${t}`).classList.add('tab-active');
            if(t === 'home') renderHome();
            if(t === 'setup') renderSetup();
            if(t === 'stats') renderStats();
        }

        function renderSetup() { renderClassesList(); renderSetsList(); renderQuestionFormBlocks(); }

        function renderClassesList() {
            const list = document.getElementById('list-classes');
            list.innerHTML = store.classes.map((c, i) => `
                <div class="bg-slate-800 p-4 rounded-xl flex justify-between items-center border border-slate-700 hover:border-blue-500/50 transition-all ${editingClassIdx === i ? 'ring-2 ring-blue-500' : ''}">
                    <div><h5 class="font-bold text-white text-xs">${c.name}</h5><p class="text-[9px] text-slate-500 uppercase">${c.students.length} Học sinh</p></div>
                    <div class="flex gap-4">
                        <button onclick="editClass(${i})" class="text-blue-400"><i class="fas fa-edit"></i></button>
                        <button onclick="store.classes.splice(${i},1);sync();renderClassesList()" class="text-red-500"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `).join('') || '<p class="text-center text-xs text-slate-600 italic">Trống</p>';
        }

        function editClass(idx) {
            editingClassIdx = idx; const cls = store.classes[idx];
            document.getElementById('setup-class-name').value = cls.name;
            document.getElementById('setup-class-students').value = cls.students.join('\n');
            document.getElementById('class-edit-badge').classList.remove('hidden-content');
            document.getElementById('btn-cancel-class').classList.remove('hidden-content');
            document.getElementById('btn-save-class').innerText = "CẬP NHẬT LỚP";
            renderClassesList();
        }

        function cancelClassEdit() {
            editingClassIdx = null; document.getElementById('setup-class-name').value = '';
            document.getElementById('setup-class-students').value = '';
            document.getElementById('class-edit-badge').classList.add('hidden-content');
            document.getElementById('btn-cancel-class').classList.add('hidden-content');
            document.getElementById('btn-save-class').innerText = "LƯU LỚP HỌC";
            renderClassesList();
        }

        function saveClassAction() {
            const name = document.getElementById('setup-class-name').value.trim(), stds = document.getElementById('setup-class-students').value.trim();
            if(!name || !stds) return;
            const arr = stds.split('\n').filter(s => s.trim());
            if(editingClassIdx !== null) store.classes[editingClassIdx] = { name, students: arr };
            else store.classes.push({ name, students: arr });
            sync(); cancelClassEdit();
        }

        function renderSetsList() {
            const list = document.getElementById('list-sets');
            list.innerHTML = store.sets.map((s, i) => {
                const config = GAME_TYPES[s.type || 'quiz'];
                return `
                    <div class="bg-slate-800 p-4 rounded-xl flex justify-between items-center border-l-4 border-${config.color}-500 ${editingSetIdx === i ? 'ring-2 ring-purple-500 bg-slate-700' : ''}">
                        <div>
                            <h5 class="font-bold text-white text-sm">${s.title}</h5>
                            <span class="text-[9px] font-black uppercase text-${config.color}-400"><i class="fas ${config.icon} mr-1"></i> ${config.name}</span>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="editSet(${i})" class="text-blue-400"><i class="fas fa-edit"></i></button>
                            <button onclick="store.sets.splice(${i},1);sync();renderSetsList()" class="text-red-500"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `;
            }).join('') || '<p class="text-center text-xs text-slate-600 italic">Trống</p>';
        }

        function editSet(idx) {
            editingSetIdx = idx; const set = store.sets[idx];
            document.getElementById('setup-set-title').value = set.title;
            document.getElementById('setup-set-type').value = set.type || 'quiz';
            tempQuestions = JSON.parse(JSON.stringify(set.q));
            document.getElementById('set-edit-badge').classList.remove('hidden-content');
            document.getElementById('btn-cancel-set').classList.remove('hidden-content');
            document.getElementById('btn-save-set').innerText = "CẬP NHẬT BỘ ĐỀ";
            renderQuestionFormBlocks(); renderSetsList();
        }

        function cancelSetEdit() {
            editingSetIdx = null; document.getElementById('setup-set-title').value = '';
            document.getElementById('setup-set-type').value = 'quiz'; tempQuestions = [];
            document.getElementById('set-edit-badge').classList.add('hidden-content');
            document.getElementById('btn-cancel-set').classList.add('hidden-content');
            document.getElementById('btn-save-set').innerText = "LƯU BỘ CÂU HỎI";
            renderQuestionFormBlocks(); renderSetsList();
        }

        function addNewQuestionToForm() {
            const type = document.getElementById('setup-set-type').value;
            let q = { text: '', exp: '' };
            if(type === 'quiz') q.opts = ['', '', '', ''], q.key = 'A';
            else if(type === 'dungsai') q.opts = ['Đúng', 'Sai'], q.key = '1';
            else if(type === 'noitu') q.opts = [''], q.key = ''; 
            else if(type === 'ochu' || type === 'dienkhuyet') q.key = '';
            tempQuestions.push(q);
            renderQuestionFormBlocks();
        }

        function renderQuestionFormBlocks() {
            const type = document.getElementById('setup-set-type').value;
            const isActivated = store.activatedGames[type];
            const guard = document.getElementById('license-guard');
            const btnAdd = document.getElementById('btn-add-q');
            const btnSave = document.getElementById('btn-save-set');
            
            if(!isActivated) { guard.classList.remove('hidden-content'); btnAdd.classList.add('opacity-30', 'pointer-events-none'); btnSave.classList.add('opacity-30', 'pointer-events-none'); }
            else { guard.classList.add('hidden-content'); btnAdd.classList.remove('opacity-30', 'pointer-events-none'); btnSave.classList.remove('opacity-30', 'pointer-events-none'); }

            const container = document.getElementById('setup-questions-editor');
            if (tempQuestions.length === 0 && isActivated) addNewQuestionToForm();

            container.innerHTML = tempQuestions.map((q, i) => {
                // LOGIC FIX: Auto-normalize keys for each type to prevent "No correct answer" errors
                if (type === 'quiz' && !['A','B','C','D'].includes(q.key)) q.key = '';
                if (type === 'dungsai' && !['1','2'].includes(q.key)) q.key = '1';

                let inputHtml = '';
                if(type === 'quiz') {
                    inputHtml = `<div class="grid grid-cols-2 gap-2">${q.opts.map((o,oi)=>`<input type="text" placeholder="Đ.án ${['A','B','C','D'][oi]}" onchange="tempQuestions[${i}].opts[${oi}]=this.value" value="${o}" class="p-2 text-[10px] rounded">`).join('')}</div>
                    <select onchange="tempQuestions[${i}].key=this.value" class="w-full p-2 text-[10px] rounded bg-blue-600 text-white">${['A','B','C','D'].map(l=>`<option value="${l}" ${q.key===l?'selected':''}>Đáp án đúng: ${l}</option>`).join('')}</select>`;
                } else if(type === 'dungsai') {
                    inputHtml = `<div class="grid grid-cols-2 gap-2"><input type="text" onchange="tempQuestions[${i}].opts[0]=this.value" value="${q.opts[0] || 'Đúng'}" class="p-2 text-[10px] rounded"><input type="text" onchange="tempQuestions[${i}].opts[1]=this.value" value="${q.opts[1] || 'Sai'}" class="p-2 text-[10px] rounded"></div>
                    <select onchange="tempQuestions[${i}].key=this.value" class="w-full p-2 text-[10px] rounded bg-emerald-600 text-white"><option value="1" ${q.key==='1'?'selected':''}>Lựa chọn 1 Đúng</option><option value="2" ${q.key==='2'?'selected':''}>Lựa chọn 2 Đúng</option></select>`;
                } else if(type === 'noitu') {
                    inputHtml = `<input type="text" placeholder="Đáp án đối ứng..." onchange="tempQuestions[${i}].opts[0]=this.value" value="${q.opts[0]}" class="w-full p-2 text-[10px] rounded text-orange-400 font-bold">`;
                } else if(type === 'ochu' || type === 'dienkhuyet') {
                    inputHtml = `<input type="text" placeholder="Từ khóa / Đáp án đúng..." onchange="tempQuestions[${i}].key=this.value" value="${q.key}" class="w-full p-2 text-[10px] rounded text-purple-400 uppercase font-black">`;
                }
                return `<div class="p-4 bg-slate-900/80 rounded-xl space-y-2 relative border border-slate-700"><button onclick="tempQuestions.splice(${i},1);renderQuestionFormBlocks()" class="absolute top-2 right-2 text-slate-600 hover:text-red-500"><i class="fas fa-times"></i></button><textarea onchange="tempQuestions[${i}].text=this.value" class="w-full p-2 text-[10px] rounded h-16" placeholder="Câu hỏi/Gợi ý...">${q.text}</textarea>${inputHtml}<input type="text" placeholder="Giải thích bài tập..." onchange="tempQuestions[${i}].exp=this.value" value="${q.exp || ''}" class="w-full p-2 text-[9px] italic rounded"></div>`;
            }).join('');
        }

        async function saveSetAction() {
            const type = document.getElementById('setup-set-type').value;
            if(!store.activatedGames[type]) return;
            const title = document.getElementById('setup-set-title').value.trim();
            if(!title || tempQuestions.length === 0) return Swal.fire('Lỗi', 'Thông tin bộ đề chưa đầy đủ.', 'warning');
            Swal.fire({ title: 'Đang lưu dữ liệu...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            if (navigator.onLine) {
                const keySaved = (store.keys && store.keys[type]) ? store.keys[type] : "";
                if(keySaved) {
                    try {
                        const r = await fetch(`${GAS_URL}?id=${store.user}&game=${type}&key=${keySaved}`);
                        const res = await r.text();
                        if (res !== "valid") {
                            store.activatedGames[type] = false;
                            delete store.keys[type];
                            sync(); updateAuthUI(); renderQuestionFormBlocks();
                            return Swal.fire('Hết hạn / Lỗi Key', 'Hệ thống đã kiểm tra và thấy Key của bạn không còn hiệu lực. Phần này đã bị khóa.', 'error');
                        }
                    } catch (e) { console.warn("Lỗi kiểm tra bản quyền, tạm bỏ qua."); }
                }
            }
            const data = { title, type, q: JSON.parse(JSON.stringify(tempQuestions)) };
            if(editingSetIdx !== null) store.sets[editingSetIdx] = data;
            else store.sets.push(data);
            sync(); cancelSetEdit();
            Swal.fire({ title: 'Đã lưu thành công!', icon: 'success', timer: 1500, showConfirmButton: false });
        }

        function renderHome() {
            const classSel = document.getElementById('sel-class');
            classSel.innerHTML = store.classes.map(c => `<option>${c.name}</option>`).join('') || '<option>Chưa có lớp</option>';
            const filter = document.getElementById('filter-game-type').value;
            const grid = document.getElementById('home-topics-grid');
            const items = store.sets.filter(s => filter === 'all' || s.type === filter);
            grid.innerHTML = items.map((s, i) => {
                const config = GAME_TYPES[s.type || 'quiz'];
                return `
                    <div onclick="preGame(${store.sets.indexOf(s)})" class="topic-card p-8 rounded-3xl cursor-pointer border-2 border-slate-800 relative overflow-hidden group">
                        <div class="absolute -right-4 -bottom-4 text-white/5 text-7xl group-hover:scale-110 transition-transform"><i class="fas ${config.icon}"></i></div>
                        <h4 class="font-black text-xl mb-1 text-white">${s.title}</h4>
                        <span class="px-2 py-0.5 rounded bg-${config.color}-600/20 text-${config.color}-400 text-[9px] font-black uppercase tracking-widest">${config.name}</span>
                        <p class="text-slate-500 text-[10px] mt-6 font-bold uppercase tracking-tighter">${s.q.length} CÂU HỎI</p>
                    </div>
                `;
            }).join('') || '<p class="col-span-full text-center py-20 text-slate-600 font-black uppercase">Trống</p>';
        }

        function preGame(idx) {
            const cIdx = document.getElementById('sel-class').selectedIndex;
            if(store.classes.length === 0) return Swal.fire('Thông báo', 'Cần tạo lớp học trước.', 'info');
            const students = store.classes[cIdx].students;
            if(!students.length) return Swal.fire('Lỗi', 'Lớp này không có học sinh.', 'error');
            document.getElementById('dashboard-view').classList.add('hidden-content');
            document.getElementById('picker-view').classList.remove('hidden-content');
            let count = 0;
            const timer = setInterval(() => {
                const name = students[Math.floor(Math.random() * students.length)];
                document.getElementById('spinning-name').innerText = name;
                if(++count > 25) {
                    clearInterval(timer); play.student = name;
                    setTimeout(() => startMainGame(idx), 1000);
                }
            }, 70);
        }

        function startMainGame(idx) {
            const set = store.sets[idx];
            play.type = set.type || 'quiz'; play.q = JSON.parse(JSON.stringify(set.q));
            play.title = set.title; play.cur = 0; play.score = 0; play.noituMatched = 0;
            play.ochuRevealed = []; play.ochuSolved = [];
            document.getElementById('picker-view').classList.add('hidden-content');
            document.getElementById('game-view').classList.remove('hidden-content');
            document.getElementById('game-student-name').innerText = play.student;
            renderGameStep();
        }

        function renderGameStep() {
            const q = play.q[play.cur];
            const content = document.getElementById('game-content');
            document.getElementById('game-bar').style.width = (play.cur / play.q.length * 100) + '%';
            document.getElementById('game-score').innerText = play.score;
            content.innerHTML = '';
            if (play.type === 'quiz') {
                let html = `<div class="text-center mb-10"><span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Câu hỏi ${play.cur+1}</span><h2 class="text-2xl font-black text-white mt-4 leading-relaxed">${q.text}</h2></div>`;
                html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto w-full px-4">`;
                ['A','B','C','D'].forEach((l, i) => {
                    html += `<div onclick="evalGeneric('${l}', this)" data-label="${l}" class="answer-btn p-6 rounded-2xl font-bold border-2"><span class="answer-label-box w-10 h-10 rounded-xl flex items-center justify-center mr-5 text-[10px] font-black">${l}</span><div class="flex-1">${q.opts[i]}</div></div>`;
                });
                content.innerHTML = html + `</div>` + createFeedbackArea();
            } else if (play.type === 'dungsai') {
                let html = `<div class="text-center mb-10"><span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Câu hỏi ${play.cur+1}</span><h2 class="text-2xl font-black text-white mt-4 px-4 min-h-[120px] flex items-center justify-center">${q.text}</h2></div>`;
                html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-3xl mx-auto w-full px-4">`;
                ['1', '2'].forEach((l, i) => {
                    html += `<div onclick="evalGeneric('${l}', this)" data-label="${l}" class="answer-btn p-10 rounded-[32px] font-black text-xl justify-center border-2"><span class="answer-label-box w-12 h-12 rounded-2xl flex items-center justify-center mr-6 text-sm font-black">${l}</span>${q.opts[i]}</div>`;
                });
                content.innerHTML = html + `</div>` + createFeedbackArea();
            } else if (play.type === 'noitu') {
                renderMatching(content);
            } else if (play.type === 'ochu') {
                renderCrossword(content);
            } else if (play.type === 'dienkhuyet') {
                let html = `<div class="text-center mb-10"><span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Câu hỏi ${play.cur+1}</span><h2 class="text-2xl md:text-4xl font-black text-white mt-8 px-4">${q.text}</h2></div>`;
                html += `<div class="max-w-2xl mx-auto w-full px-4 space-y-8"><input type="text" id="dk-inp" placeholder="Nhập đáp án tại đây..." class="blank-input-large" onkeydown="if(event.key==='Enter') checkDienkhuyet()"><div class="flex justify-center"><button id="btn-check-dk" onclick="checkDienkhuyet()" class="bg-blue-600 px-16 py-5 rounded-2xl font-black uppercase text-xs shadow-xl transition hover:scale-105">Kiểm tra kết quả</button></div></div>`;
                content.innerHTML = html + createFeedbackArea();
            }
            if(window.MathJax) MathJax.typesetPromise();
        }

        function createFeedbackArea() {
            return `<div id="game-feedback" class="hidden-content mt-12 p-8 rounded-[40px] border-l-8 italic text-slate-300 text-sm max-w-2xl mx-auto w-full shadow-2xl"></div><div id="game-action" class="hidden-content mt-8 text-center pb-12"><button onclick="nextStep()" class="bg-white text-slate-900 px-16 py-5 rounded-2xl font-black uppercase text-xs shadow-2xl hover:scale-105 transition-transform">Tiếp theo <i class="fas fa-arrow-right ml-2"></i></button></div>`;
        }

        function evalGeneric(choice, el) {
            const q = play.q[play.cur];
            const isRight = choice === q.key;
            document.querySelectorAll('.answer-btn').forEach(b => {
                b.classList.add('pointer-events-none', 'opacity-50');
                if(b.dataset.label === q.key) b.classList.add('correct', 'opacity-100');
            });
            if(isRight) { 
                play.score++; 
                el.classList.add('correct'); 
                confetti({ particleCount: 40, spread: 60, origin: { y: 0.8 } }); 
                playSfx('correct');
            } else { 
                el.classList.add('incorrect');
                playSfx('wrong');
            }
            showFeedback(q.exp, isRight ? '<b class="text-emerald-400">CHÍNH XÁC!</b>' : '<b class="text-red-500">RẤT TIẾC!</b>');
        }

        function checkDienkhuyet() {
            const q = play.q[play.cur]; const input = document.getElementById('dk-inp');
            const user = input.value.trim().toLowerCase(); const correct = q.key.toLowerCase();
            input.disabled = true; document.getElementById('btn-check-dk').classList.add('hidden-content');
            if(user === correct) { 
                play.score++; 
                input.classList.add('border-emerald-500', 'bg-emerald-900/30'); 
                confetti({ particleCount: 40 }); 
                showFeedback(q.exp, '<b class="text-emerald-400">CHÍNH XÁC!</b>'); 
                playSfx('correct');
            } else { 
                input.classList.add('border-red-500', 'bg-red-900/30'); 
                showFeedback(q.exp, `<b class="text-red-500">SAI RỒI!</b> Đáp án: <span class="underline">${q.key}</span>`); 
                playSfx('wrong');
            }
        }

        function renderMatching(container) {
            container.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full p-2"><div class="lg:col-span-4 bg-slate-900/50 p-6 rounded-3xl border border-slate-800 flex flex-col"><h4 class="text-[10px] font-black text-slate-500 uppercase mb-6 tracking-widest">Kéo nội dung</h4><div id="drag-container" class="space-y-4 overflow-y-auto flex-grow"></div></div><div class="lg:col-span-8 bg-slate-800/20 p-6 rounded-3xl border border-slate-700 flex flex-col"><h4 class="text-[10px] font-black text-slate-500 uppercase mb-6 tracking-widest">Thả vào kết quả đúng</h4><div id="drop-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto flex-grow"></div></div></div><div id="matching-action" class="hidden-content text-center py-8"><button onclick="showResult()" class="bg-blue-600 text-white px-16 py-5 rounded-2xl font-black uppercase text-xs shadow-2xl animate-bounce">Hoàn thành bài tập <i class="fas fa-check-circle ml-2"></i></button></div>`;
            const dragBox = document.getElementById('drag-container'), dropBox = document.getElementById('drop-container');
            const shuffledQ = [...play.q].sort(() => Math.random() - 0.5);
            const shuffledAns = [...play.q].sort(() => Math.random() - 0.5);
            shuffledQ.forEach(item => {
                const el = document.createElement('div');
                el.className = 'drag-item p-5 rounded-2xl font-bold text-[13px] shadow-lg border-b-4 border-slate-700 hover:border-blue-500 transition-all';
                el.innerHTML = item.text; el.draggable = true; el.dataset.ans = item.opts[0];
                el.addEventListener('dragstart', e => { e.dataTransfer.setData('ans', item.opts[0]); el.style.opacity = '0.4'; });
                el.addEventListener('dragend', () => el.style.opacity = '1');
                el.addEventListener('touchstart', handleTouch, {passive: false});
                dragBox.appendChild(el);
            });
            shuffledAns.forEach(item => {
                const zone = document.createElement('div');
                zone.className = 'drop-zone'; zone.dataset.expected = item.opts[0];
                zone.innerHTML = `<div class="text-base font-black text-blue-400">${item.opts[0]}</div>`;
                zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', e => {
                    e.preventDefault(); zone.classList.remove('drag-over');
                    const ans = e.dataTransfer.getData('ans'); evalMatch(ans, zone);
                });
                dropBox.appendChild(zone);
            });
        }

        function evalMatch(ans, zone) {
            if(ans === zone.dataset.expected) {
                const item = Array.from(document.querySelectorAll('.drag-item')).find(el => el.dataset.ans === ans);
                item.classList.add('matched'); zone.classList.add('correct-match');
                zone.innerHTML += `<div class="bg-emerald-500 text-white px-3 py-1 rounded-full text-[9px] mt-2 font-black uppercase"><i class="fas fa-check mr-1"></i> Chính xác</div>`;
                play.score++; play.noituMatched++; confetti({ particleCount: 20, spread: 50, origin: { y: 0.8 } });
                playSfx('correct');
                if(play.noituMatched === play.q.length) document.getElementById('matching-action').classList.remove('hidden-content');
            } else { 
                zone.classList.add('wrong-match'); 
                playSfx('wrong');
                setTimeout(() => zone.classList.remove('wrong-match'), 600); 
            }
            if(window.MathJax) MathJax.typesetPromise();
        }

        function handleTouch(e) {
            const card = e.currentTarget; if(card.classList.contains('matched')) return;
            const rect = card.getBoundingClientRect();
            const shiftX = e.touches[0].clientX - rect.left, shiftY = e.touches[0].clientY - rect.top;
            function move(m) {
                const t = m.touches[0]; card.style.position = 'fixed'; card.style.zIndex = '1000'; card.style.pointerEvents = 'none';
                card.style.left = (t.clientX - shiftX) + 'px'; card.style.top = (t.clientY - shiftY) + 'px';
            }
            function end(ed) {
                const t = ed.changedTouches[0]; card.style.display = 'none';
                const target = document.elementFromPoint(t.clientX, t.clientY); card.style.display = '';
                const zone = target?.closest('.drop-zone');
                card.style.position = ''; card.style.zIndex = ''; card.style.pointerEvents = ''; card.style.left = ''; card.style.top = '';
                if(zone) evalMatch(card.dataset.ans, zone);
                document.removeEventListener('touchmove', move); document.removeEventListener('touchend', end);
            }
            document.addEventListener('touchmove', move, {passive: false}); document.addEventListener('touchend', end);
        }

        function renderCrossword(container) {
            container.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full"><div class="lg:col-span-5 bg-slate-900/50 p-6 rounded-3xl border border-slate-800 flex flex-col"><h4 class="text-[10px] font-black text-blue-500 uppercase mb-6 tracking-widest">Gợi ý câu hỏi</h4><div id="ochu-hints" class="space-y-4 overflow-y-auto flex-grow"></div></div><div class="lg:col-span-7 bg-slate-800/20 p-8 rounded-3xl border border-slate-700 flex flex-col items-center"><h4 class="text-[10px] font-black text-purple-500 uppercase mb-10 tracking-widest">Bảng giải ô chữ hàng ngang</h4><div id="ochu-board" class="space-y-6 w-full flex flex-col items-center overflow-y-auto pr-2"></div><div id="ochu-action" class="hidden-content mt-12"><button onclick="showResult()" class="bg-blue-600 px-12 py-5 rounded-2xl font-black uppercase text-xs shadow-2xl">Kết thúc bài giải <i class="fas fa-flag-checkered ml-2"></i></button></div></div></div>`;
            const hintBox = document.getElementById('ochu-hints'), boardBox = document.getElementById('ochu-board');
            play.q.forEach((q, i) => {
                const revealed = play.ochuRevealed.includes(i), solved = play.ochuSolved.includes(i);
                const h = document.createElement('div');
                h.className = `p-4 rounded-2xl border transition-all ${revealed ? 'bg-slate-900 border-blue-500/50' : 'bg-slate-900 border-slate-800'}`;
                h.innerHTML = `<span class="w-7 h-7 rounded-full bg-slate-800 flex items-center justify-center font-black text-[10px] shrink-0 mr-4 text-slate-500">${i+1}</span><div class="flex-1">${revealed ? `<div class="text-xs font-bold text-slate-100">${q.text}</div>` : `<button onclick="play.ochuRevealed.push(${i});renderCrossword(document.getElementById('game-content'))" class="w-full py-2 bg-blue-600/20 text-blue-400 rounded-xl text-[9px] font-black uppercase tracking-widest">Xem gợi ý ${i+1}</button>`}</div>`;
                hintBox.appendChild(h);
                const row = document.createElement('div'); row.className = 'flex items-center gap-2 group';
                let rowH = `<span class="w-5 text-[10px] font-black text-slate-600">${i+1}</span><div class="flex gap-1">`;
                q.key.split('').forEach((c, ci) => { rowH += `<input type="text" id="oc-${i}-${ci}" class="char-box ${!revealed ? 'opacity-10 pointer-events-none' : ''} ${solved ? 'char-correct' : ''}" maxlength="1" value="${solved ? c : ''}" ${solved ? 'disabled' : ''} oninput="if(this.value) document.getElementById('oc-${i}-${ci+1}')?.focus()" onkeydown="if(event.key==='Backspace' && !this.value) document.getElementById('oc-${i}-${ci-1}')?.focus()">`; });
                rowH += `</div><button onclick="checkOchuRow(${i})" class="p-3 bg-slate-800 text-blue-400 rounded-xl text-[10px] font-black opacity-0 group-hover:opacity-100 transition-opacity ${!revealed || solved ? 'hidden' : ''}">GỬI</button>`;
                row.innerHTML = rowH; boardBox.appendChild(row);
            });
        }

        function checkOchuRow(idx) {
            const q = play.q[idx]; let user = "";
            for(let i=0; i<q.key.length; i++) user += document.getElementById(`oc-${idx}-${i}`).value.toUpperCase();
            if(user === q.key.toUpperCase()) {
                play.ochuSolved.push(idx); play.score++; confetti({ particleCount: 30, spread: 60 });
                playSfx('correct');
                renderCrossword(document.getElementById('game-content'));
                if(play.ochuSolved.length === play.q.length) document.getElementById('ochu-action').classList.remove('hidden-content');
            } else {
                playSfx('wrong');
                for(let i=0; i<q.key.length; i++) { const e = document.getElementById(`oc-${idx}-${i}`); e.classList.add('char-wrong'); setTimeout(() => e.classList.remove('char-wrong'), 800); }
            }
        }

        function showFeedback(exp, head = '') {
            const fb = document.getElementById('game-feedback');
            fb.className = `mt-12 p-8 rounded-[40px] border-l-8 italic text-slate-300 text-sm max-w-2xl mx-auto w-full shadow-2xl ${head.includes('SAI') ? 'bg-red-900/20 border-red-500' : 'bg-blue-900/20 border-blue-500'}`;
            fb.innerHTML = `${head ? head + '<br><br>' : ''}<b class="text-blue-400 uppercase text-[10px]">Giải thích:</b> ${exp || 'Không có giải thích cho câu này.'}`;
            fb.classList.remove('hidden-content'); document.getElementById('game-action').classList.remove('hidden-content');
        }

        function nextStep() {
            play.cur++; if(play.cur < play.q.length) renderGameStep(); else showResult();
        }

        function showResult() {
            playSfx('win');
            document.getElementById('game-view').classList.add('hidden-content');
            document.getElementById('result-view').classList.remove('hidden-content');
            const total = play.q.length; const acc = Math.round((play.score / total) * 100);
            document.getElementById('res-student').innerText = `KẾT QUẢ: ${play.student}`;
            document.getElementById('res-score').innerText = `${play.score}/${total}`;
            document.getElementById('res-acc').innerText = `${acc}%`;
            store.history.push({ name: play.student, acc: acc, type: play.type, topic: play.title, date: new Date().toLocaleDateString('vi-VN') });
            sync();
        }

        function renderStats() {
            if(!store.active) return;
            const s = document.getElementById('stats-summary'); const h = store.history;
            const avg = h.length > 0 ? Math.round(h.reduce((a,b)=>a+b.acc,0)/h.length) : 0;
            s.innerHTML = `
                <div class="glass-card p-6 rounded-2xl text-center"><p class="text-[10px] text-slate-500 uppercase font-black">Chính xác TB</p><h2 class="text-3xl font-black text-blue-500">${avg}%</h2></div>
                <div class="glass-card p-6 rounded-2xl text-center"><p class="text-[10px] text-slate-500 uppercase font-black">Lượt chơi</p><h2 class="text-3xl font-black text-white">${h.length}</h2></div>
                <div class="glass-card p-6 rounded-2xl text-center"><p class="text-[10px] text-slate-500 uppercase font-black">Bộ đề</p><h2 class="text-3xl font-black text-purple-500">${store.sets.length}</h2></div>
                <div class="glass-card p-6 rounded-2xl text-center"><p class="text-[10px] text-slate-500 uppercase font-black">Lớp học</p><h2 class="text-3xl font-black text-emerald-500">${store.classes.length}</h2></div>
            `;
            const lb = document.getElementById('leaderboards-container');
            lb.innerHTML = Object.keys(GAME_TYPES).map(t => {
                const cfg = GAME_TYPES[t]; const top = h.filter(i => i.type === t).sort((a,b)=>b.acc-a.acc).slice(0,5);
                return `<div class="glass-card p-6 rounded-2xl border-t-4 border-${cfg.color}-500 flex flex-col h-full"><h4 class="text-[10px] font-black text-white uppercase mb-4 flex items-center justify-between"><span>${cfg.name}</span><i class="fas ${cfg.icon} opacity-30"></i></h4><div class="space-y-2 flex-grow">${top.map((x, i) => `<div class="flex justify-between p-2 bg-slate-900/50 rounded-lg text-[11px]"><span class="font-bold text-slate-300">${i+1}. ${x.name}</span><span class="font-black text-${cfg.color}-400">${x.acc}%</span></div>`).join('') || '<p class="text-[10px] text-slate-600 italic py-2 text-center">Chưa có dữ liệu</p>'}</div></div>`;
            }).join('');
            const tb = document.getElementById('stats-performance-table');
            const map = {}; h.forEach(x => { const k = `${x.topic}|${x.type}`; if(!map[k]) map[k] = { topic: x.topic, type: x.type, count: 0, sum: 0 }; map[k].count++; map[k].sum += x.acc; });
            tb.innerHTML = Object.values(map).map(d => `<tr class="border-b border-slate-800 hover:bg-slate-800/30 transition-colors"><td class="p-4 font-bold text-white">${d.topic}</td><td class="p-4 text-[10px] font-black uppercase text-${GAME_TYPES[d.type].color}-400">${GAME_TYPES[d.type].name}</td><td class="p-4 text-slate-400 font-bold">${d.count}</td><td class="p-4"><span class="px-3 py-1 bg-blue-600/20 text-blue-400 rounded-full font-black text-xs">${Math.round(d.sum/d.count)}%</span></td></tr>`).join('');
        }

        function timedReset(type) {
            Swal.fire({ title: 'Xác nhận xóa?', text: 'Dữ liệu sẽ bị xóa vĩnh viễn!', icon: 'warning', showCancelButton: true, background: '#0f172a', color: '#fff' }).then(r => { 
                if(r.isConfirmed) { if(type === 'stats') { store.history = []; sync(); renderStats(); } else { localStorage.clear(); location.reload(); } } 
            });
        }

        function confirmExitGame() {
            Swal.fire({ title: 'Thoát bài?', icon: 'warning', showCancelButton: true, background: '#0f172a', color: '#fff' }).then(r => { if(r.isConfirmed) location.reload(); });
        }

        window.onload = () => { updateAuthUI(); updateSoundUI(); renderHome(); if(window.MathJax) MathJax.typesetPromise(); };
    </script>
</body>
</html>

